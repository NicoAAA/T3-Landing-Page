---
// src/components/index/InstagramCarrousel.astro
import { Image } from 'astro:assets';
import fashionOneImg from '../../assets/novedades/Fashion-one.jpg';
import fashionTwoImg from '../../assets/novedades/Fashion-two.jpg';
import fashionThreeImg from '../../assets/novedades/Fashion-three.jpg';
import fashionFourImg from '../../assets/novedades/Fashion-four.jpg';

const LOCAL_POSTS = [
  { image: fashionOneImg, description: "Nuestros nuevos diseños..." },
  { image: fashionTwoImg, description: "La calidad se siente..." },
  { image: fashionThreeImg, description: "Colores que inspiran..." },
  { image: fashionFourImg, description: "Innovación y tradición..." }
];

const { posts = LOCAL_POSTS } = Astro.props;

function truncateText(text, maxLength) {
  if (!text || text.length <= maxLength) return text;
  return text.substring(0, text.lastIndexOf(" ", maxLength)) + "...";
}
---

<div class="w-full overflow-hidden relative py-16 bg-theme cursor-grab active:cursor-grabbing select-none" id="carouselContainer">
  <div id="instaTrack" class="flex gap-6 w-max will-change-transform">
    {/* 1. DUPLICACIÓN EN SERVIDOR: Renderizamos dos veces para el efecto infinito sin JS pesado */}
    {[...posts, ...posts].map((post) => (
      <article class="carousel-item group relative flex-shrink-0 flex flex-col bg-second-theme rounded-2xl shadow-md overflow-hidden w-[85vw] max-w-[400px] md:w-[320px] lg:w-[360px] transition-all duration-500 hover:scale-105">
        <div class="relative w-full aspect-square overflow-hidden">
          <Image 
            src={post.image} 
            alt="Instagram Post" 
            loading="lazy" 
            draggable="false"
            decoding="async"
            class="w-full h-full object-cover"
            widths={[300, 400]}
          />
        </div>
        <div class="p-5 flex-grow bg-surface">
          <p class="text-muted text-sm leading-relaxed">{truncateText(post.description, 120)}</p>
        </div>
      </article>
    ))}
  </div>
</div>

<script>
  // Eliminamos window.addEventListener('load') para que se ejecute de inmediato de forma optimizada
  const track = document.getElementById('instaTrack');
  const container = document.getElementById('carouselContainer');
  
  if (track && container) {
    let currentX = 0;
    const baseSpeed = 0.8; 
    let isDragging = false;
    let isVisible = false;
    let startX = 0;
    let lastX = 0;

    // 2. INTERSECTION OBSERVER: Solo anima si el carrusel es visible
    const observer = new IntersectionObserver((entries) => {
      isVisible = entries[0].isIntersecting;
    }, { threshold: 0.1 });
    
    observer.observe(container);

    const animate = () => {
      if (!isDragging && isVisible) {
        currentX -= baseSpeed;
        
        // Reinicio suave usando la mitad del ancho (ya que duplicamos los posts)
        const halfWidth = track.scrollWidth / 2;
        if (Math.abs(currentX) >= halfWidth) {
          currentX = 0;
        }
        
        track.style.transform = `translate3d(${currentX}px, 0, 0)`;
      }
      requestAnimationFrame(animate);
    };

    // DRAG LOGIC (Simplificada)
    const onStart = (e) => {
      isDragging = true;
      startX = e.pageX || e.touches[0].pageX;
      lastX = currentX;
      container.style.cursor = 'grabbing';
    };

    const onMove = (e) => {
      if (!isDragging) return;
      const x = e.pageX || e.touches[0].pageX;
      const walk = x - startX;
      currentX = lastX + walk;
      track.style.transform = `translate3d(${currentX}px, 0, 0)`;
    };

    const onEnd = () => {
      isDragging = false;
      container.style.cursor = 'grab';
    };

    container.addEventListener('mousedown', onStart);
    container.addEventListener('touchstart', onStart, { passive: true });
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove, { passive: true });
    window.addEventListener('mouseup', onEnd);
    window.addEventListener('touchend', onEnd);

    requestAnimationFrame(animate);
  }
</script>