---
// src/components/Fashion-News/ImmersiveView.astro
import { sanityClient } from "sanity:client";
import imageUrlBuilder from '@sanity/image-url';

// 1. Configuramos el builder para transformar los objetos de Sanity en URLs
const builder = imageUrlBuilder(sanityClient);
function urlFor(source: any) {
  return builder.image(source);
}

interface DigitColumn {
  strip: string[];
  mapping: number[];
}

interface Props {
  digitColumns: DigitColumn[]; 
  newsItems: any[]; 
}

const { newsItems, digitColumns } = Astro.props;
---

<div id="immersive-view-container">
      
    {/* HEADER AÑO */}
    <div id="year-sticky-wrapper" class="sticky top-0 z-[60] w-full bg-theme shadow-xl border-b border-white/10 hidden">
        <div class="container mx-auto max-w-7xl flex justify-center items-center py-2 h-20 md:h-24">
            <div id="year-counter-container" class="h-16 md:h-20 w-max relative flex justify-center gap-0.5 md:gap-0.5 px-4">
                {digitColumns.map((colData, index) => (
                    <div class="h-16 md:h-20 overflow-hidden relative w-[28px] md:w-[36px] flex justify-center">
                        <div class="digit-strip flex flex-col items-center transition-transform duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)]"
                             style={`transition-delay: ${(digitColumns.length - 1 - index) * 150}ms`}
                             data-col-index={index}>
                            {colData.strip.map((digit) => (
                                <div class="h-16 md:h-20 flex items-center justify-center flex-shrink-0">
                                    <span class="text-4xl md:text-5xl font-titulo font-bold text-button tracking-tight drop-shadow-sm leading-none">{digit}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
                <div class="absolute bottom-2 md:bottom-2 left-0 right-0 mx-auto w-full max-w-[90%] h-1 md:h-1.5 bg-[#8b9e8d] rounded-full opacity-90 z-10"></div>
            </div>
        </div>
    </div>

    {/* CONTENEDOR DE ARTÍCULOS */}
    <div id="immersive-content-layer" class="relative z-0 pt-0 md:pt-24">
        {newsItems.map((item: any, index: number) => (
            <article class="news-article-wrapper border-b border-white/5 last:border-0" data-description={item.description} data-year={item.year}>
                <div class="immersive-view relative h-[120vh] md:h-[150vh]">
                    <div class="sticky top-0 h-screen w-full overflow-hidden flex flex-col justify-center bg-theme pt-16 sm:pt-0">
                        
                        <div class={`container mx-auto px-4 md:px-6 max-w-7xl h-full flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8 md:gap-16 ${index % 2 !== 0 ? 'sm:flex-row-reverse' : ''}`}>
                            
                            <div class="w-full sm:w-1/2 flex flex-col justify-center z-10 order-2 sm:order-1 h-auto relative shrink-0">
                                <h3 class="immersive-title text-3xl sm:text-3xl md:text-5xl font-titulo font-bold text-button mb-3 sm:mb-4 md:mb-8 opacity-0 transition-opacity duration-300 text-center sm:text-left leading-tight drop-shadow-md">
                                    {item.title}
                                </h3>
                                
                                <div class="relative h-auto w-full max-w-xl mx-auto sm:mx-0">
                                    <div class="line-reveal-container text-sm sm:text-sm md:text-xl text-primary leading-snug font-body border-l-2 md:border-l-4 border-[#A5BBA7] pl-3 md:pl-6 bg-white/5 p-3 md:p-6 rounded-r-lg backdrop-blur-sm max-h-[20vh] sm:max-h-none overflow-y-auto sm:overflow-visible scrollbar-hide">
                                    </div>
                                </div>
                                
                                <div class="immersive-btn mt-4 md:mt-10 opacity-0 transition-opacity duration-500 flex justify-center sm:justify-start">
                                </div>
                            </div>

                            <div class="w-full sm:w-1/2 relative flex items-center justify-center order-1 sm:order-2">
                                <div class="immersive-image-wrapper relative h-[55vh] w-auto aspect-[3/4] sm:aspect-auto sm:h-[60vh] sm:w-full overflow-hidden shadow-2xl transition-all duration-300 ease-out rounded-sm border-secondTheme mx-auto sm:mx-0">
                                    {/* ESTA ES LA CORRECCIÓN CLAVE:
                                        Usamos urlFor para convertir el objeto 'item.image' en una URL real.
                                        Optimizamos ancho a 800px y formato WebP para el reporte de Lighthouse.
                                    */}
                                    <img 
                                        src={urlFor(item.image).width(800).format('webp').url()} 
                                        alt={item.title} 
                                        class="w-full h-full object-cover" 
                                        loading={index === 0 ? "eager" : "lazy"}
                                        decoding="async"
                                    />
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </article>
        ))}
    </div>
</div>