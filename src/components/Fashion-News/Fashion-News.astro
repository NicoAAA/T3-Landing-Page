---
// src/components/Fashion-News.astro
import { sanityClient } from "sanity:client";

// 1. OBTENER DATOS DE SANITY

const data = await sanityClient.fetch(`
  *[_type == "articulo"] | order(year desc) {
    year,
    title,
    description,
    "image": image.asset->url
  }
`);

// Validamos que exista data, si no, usamos un array vacío para no romper la web
const NEWS_ITEMS = data || [];

// 1. LÓGICA PARA VISTA INMERSIVA (Lista plana de años y columnas para el contador)
const UNIQUE_YEARS_FLAT = [...new Set(NEWS_ITEMS.map((item: any) => item.year))].sort();

const digitColumns = Array.from({ length: 4 }, (_, colIndex) => {
  const strip: string[] = [];    
  const mapping: number[] = []; 
  let lastDigit: string | null = null;
  let currentStripIndex = -1;

  UNIQUE_YEARS_FLAT.forEach((year) => {
    // Aseguramos que year sea string por si acaso
    const yearStr = String(year);
    const digit = yearStr[colIndex]; 
    
    if (digit !== lastDigit) {
      strip.push(digit);
      currentStripIndex++;
      lastDigit = digit;
    }
    mapping.push(currentStripIndex);
  });
  return { strip, mapping };
});

const clientMappings = digitColumns.map(col => col.mapping);

// 3. LÓGICA PARA VISTA ESTÁNDAR (Agrupación por Año)
const postsByYear = NEWS_ITEMS.reduce((acc: any, post: any) => {
    if (!acc[post.year]) acc[post.year] = [];
    acc[post.year].push(post);
    return acc;
}, {});

const sortedYears = Object.keys(postsByYear).sort();
---

<div id="fashion-news-container" class="relative bg-theme font-body min-h-screen">

  <button id="mode-toggle-btn" class="fixed bottom-6 left-3 md:left-6 z-[60] bg-[#1c1c2e]/90 backdrop-blur-sm text-white shadow-xl rounded-full flex items-center overflow-hidden transition-all duration-500 ease-in-out h-14 w-14 border border-primary">
    <div class="w-14 h-14 flex items-center justify-center flex-shrink-0 relative">
      <svg id="icon-to-standard" class="w-6 h-6 absolute transition-all opacity-100 rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
      <svg id="icon-to-immersive" class="w-6 h-6 absolute transition-all opacity-0 -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
    </div>
    <span id="mode-text" class="whitespace-nowrap font-bold uppercase text-xs tracking-widest pr-6 pl-2 opacity-0 transition-opacity duration-300">Modo Estándar</span>
  </button>

  <div id="standard-view-container" class="hidden pt-24 pb-20 container mx-auto px-4 md:px-6 max-w-7xl">
      {sortedYears.map((year) => (
          <section class="year-section mb-20">
              <div class="flex items-center mb-10 text-button">
                  <h2 class="text-6xl md:text-8xl font-titulo font-bold text-button opacity-20 mr-6">{year}</h2>
                  <div class="h-px flex-grow bg-primary/20"></div>
              </div>
              <div class="space-y-16">
                  {postsByYear[year].map((item: any, index: number) => (
                      <div class={`flex flex-col md:flex-row items-center gap-8 md:gap-12 ${index % 2 !== 0 ? 'md:flex-row-reverse' : ''}`}>
                          <div class="w-full md:w-1/2">
                              <div class="aspect-[4/5] w-full relative overflow-hidden shadow-lg group rounded-sm">
                                  <img src={item.image} alt={item.title} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                              </div>
                          </div>
                          <div class="w-full md:w-1/2 text-center md:text-left">
                              <h3 class="text-2xl md:text-4xl font-titulo font-bold text-primary mb-4 md:mb-6 leading-tight">{item.title}</h3>
                              <p class="text-sm md:text-lg text-primary leading-relaxed font-body mb-6">{item.description}</p>
                              <button class="border-b-2 border-brand text-brand pb-1 hover:text-[#8b9e8d] hover:border-[#8b9e8d] transition-colors duration-300 font-bold uppercase tracking-widest text-xs md:text-sm">Leer Más</button>
                          </div>
                      </div>
                  ))}
              </div>
          </section>
      ))}
  </div>

  <div id="immersive-view-container">
      
      <div id="year-sticky-wrapper" class="sticky top-0 z-50 w-full bg-[#1c1c2e] shadow-lg border-b border-white/10 hidden">
        <div class="container mx-auto max-w-7xl flex justify-center items-center py-2 h-20 md:h-24">
            <div id="year-counter-container" class="h-16 md:h-20 w-max relative flex justify-center gap-0.5 md:gap-0.5 px-4">
                {digitColumns.map((colData, index) => (
                    <div class="h-16 md:h-20 overflow-hidden relative w-[28px] md:w-[36px] flex justify-center">
                        <div class="digit-strip flex flex-col items-center transition-transform duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)]"
                             style={`transition-delay: ${(digitColumns.length - 1 - index) * 150}ms`}
                             data-col-index={index}>
                            {colData.strip.map((digit) => (
                                <div class="h-16 md:h-20 flex items-center justify-center flex-shrink-0">
                                    <span class="text-4xl md:text-5xl font-titulo font-bold text-white tracking-tight drop-shadow-sm leading-none">{digit}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
                <div class="absolute bottom-2 md:bottom-2 left-0 right-0 mx-auto w-full max-w-[90%] h-1 md:h-1.5 bg-[#8b9e8d] rounded-full opacity-90 z-10"></div>
            </div>
        </div>
      </div>

      <div class="relative z-10 pt-4">
        {NEWS_ITEMS.map((item: any, index: number) => (
            <article class="news-article-wrapper border-b border-white/5 last:border-0" data-description={item.description} data-year={item.year}>
                <div class="immersive-view relative h-[120vh] md:h-[150vh]">
                    <div class="sticky top-0 h-screen w-full overflow-hidden flex flex-col justify-center bg-theme">
                        <div class={`container mx-auto px-4 md:px-6 max-w-7xl h-full flex flex-col md:flex-row items-center justify-center gap-6 md:gap-12 ${index % 2 !== 0 ? 'md:flex-row-reverse' : ''}`}>
                            <div class="w-full md:w-1/2 flex flex-col justify-center z-10 order-2 md:order-1 h-auto py-4 md:py-0">
                                <h3 class="immersive-title text-2xl sm:text-3xl lg:text-5xl font-titulo font-bold text-button mb-3 md:mb-6 opacity-0 transition-opacity duration-300 text-center md:text-left leading-tight">{item.title}</h3>
                                <div class="relative h-auto w-full">
                                    <div class="line-reveal-container text-sm sm:text-base lg:text-xl text-primary leading-relaxed font-body border-l-2 md:border-l-4 border-[#A5BBA7] pl-3 md:pl-6 bg-white/5 p-2 md:p-4 rounded-r-lg"></div>
                                </div>
                                <div class="immersive-btn mt-4 md:mt-8 opacity-0 transition-opacity duration-500 flex justify-center md:justify-start">
                                    <button class="bg-action text-white px-8 py-3 hover:bg-[#8b9e8d] transition-colors duration-300 flex items-center gap-3 uppercase tracking-widest text-[10px] md:text-sm font-bold shadow-lg rounded-full">Ver Detalles</button>
                                </div>
                            </div>
                            <div class="w-full md:w-1/2 h-[35vh] md:h-[60vh] relative flex items-center justify-center order-1 md:order-2">
                                <div class="immersive-image-wrapper relative w-full h-full overflow-hidden shadow-xl bg-gray-100 transition-transform duration-100 ease-out rounded-sm">
                                    <img src={item.image} alt={item.title} class="w-full h-full object-cover" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        ))}
      </div>
  </div>

</div>

<script define:vars={{ uniqueYears: UNIQUE_YEARS_FLAT, clientMappings }}>
  const btn = document.getElementById('mode-toggle-btn');
  const btnText = document.getElementById('mode-text');
  const standardContainer = document.getElementById('standard-view-container');
  const immersiveContainer = document.getElementById('immersive-view-container');
  const yearWrapper = document.getElementById('year-sticky-wrapper');
  const digitStrips = document.querySelectorAll('.digit-strip');
  
  let YEAR_HEIGHT = 80; 

  function updateDimensions() {
    // Solo ajustamos la altura de desplazamiento de los números, no el nav
    if (window.innerWidth < 768) {
        YEAR_HEIGHT = 64; 
    } else {
        YEAR_HEIGHT = 80; 
    }
  }

  let isImmersiveMode = true;
  let isAnimating = false;

  function checkMode() {
    if (isImmersiveMode) {
      if(standardContainer) standardContainer.classList.add('hidden');
      if(immersiveContainer) immersiveContainer.classList.remove('hidden');
      if(yearWrapper) {
          yearWrapper.classList.remove('hidden');
          yearWrapper.style.display = 'block'; 
      }
      if(btnText) btnText.innerText = "Modo Inmersivo";
      setupLines();
    } else {
      if(standardContainer) standardContainer.classList.remove('hidden');
      if(immersiveContainer) immersiveContainer.classList.add('hidden');
      if(yearWrapper) {
          yearWrapper.classList.add('hidden');
          yearWrapper.style.display = 'none';
      }
      if(btnText) btnText.innerText = "Modo Estándar";
    }
  }

  if (btn) {
    btn.addEventListener('click', () => {
      if(isAnimating) return;
      isAnimating = true;
      isImmersiveMode = !isImmersiveMode;
      checkMode();
      btn.style.width = "210px";
      btnText.style.opacity = "1";
      setTimeout(() => {
        btn.style.width = "56px";
        btnText.style.opacity = "0";
        isAnimating = false;
      }, 3000);
    });
  }

  const articles = document.querySelectorAll('.news-article-wrapper');

  function setupLines() {
    articles.forEach(article => {
      const container = article.querySelector('.line-reveal-container');
      if (!container || container.dataset.ready === "true") return;
      const fullText = article.dataset.description || "";
      const words = fullText.split(' ').map(word => 
        `<span class="word-span inline-block transition-opacity duration-600 opacity-0 mr-1">${word}</span>`
      ).join('');
      container.innerHTML = words;
      container.dataset.ready = "true";
      container.dataset.hasTyped = "false";
    });
  }

  updateDimensions();
  window.addEventListener('resize', () => {
      updateDimensions();
      if(digitStrips.length > 0) window.dispatchEvent(new Event('scroll'));
  });

  setupLines();
  checkMode(); 

  window.addEventListener('scroll', () => {
    if (!isImmersiveMode) return;
    
    // NOTA: Eliminamos la lógica de 'Smart Sticky' (cambiar top con JS) 
    // para evitar el comportamiento errático en móvil.

    const windowHeight = window.innerHeight;
    let activeYearIndex = 0;
    let maxVisibility = 0;

    articles.forEach((article) => {
        const immersiveContainer = article.querySelector('.immersive-view');
        if (!immersiveContainer) return;

        const rect = immersiveContainer.getBoundingClientRect();
        // Cálculo de visibilidad para determinar el año activo
        const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
        const visibility = Math.max(0, visibleHeight / windowHeight);

        if (visibility > maxVisibility) {
            maxVisibility = visibility;
            const currentYear = article.dataset.year;
            activeYearIndex = uniqueYears.indexOf(currentYear);
        }
        
        // Animaciones internas del artículo (opacidad, blur, etc.)
        if (rect.bottom < 0 || rect.top > windowHeight) return;
        
        const containerHeight = immersiveContainer.offsetHeight;
        const totalScrollableDistance = containerHeight - windowHeight;
        const scrolledDistance = -rect.top;
        
        let progress = scrolledDistance / totalScrollableDistance;
        progress = Math.max(0, Math.min(1, progress));

        const imgWrapper = article.querySelector('.immersive-image-wrapper');
        const title = article.querySelector('.immersive-title');
        const btnElement = article.querySelector('.immersive-btn');
        const textContainer = article.querySelector('.line-reveal-container');

        if (textContainer) {
            if (progress > 0.01 && textContainer.dataset.hasTyped !== "true") {
                textContainer.dataset.hasTyped = "true";
                const allSpans = textContainer.querySelectorAll('.word-span');
                allSpans.forEach((span, i) => {
                    setTimeout(() => { 
                        if (textContainer.dataset.hasTyped === "true") span.style.opacity = "1"; 
                    }, i * 80); 
                });
            } else if (progress < 0.005 && textContainer.dataset.hasTyped === "true") {
                textContainer.dataset.hasTyped = "false";
                textContainer.querySelectorAll('.word-span').forEach(span => span.style.opacity = "0");
            }
        }
        if (imgWrapper) {
            const imageOpacity = Math.min(1, progress * 5);
            imgWrapper.style.opacity = imageOpacity;
            imgWrapper.style.filter = `blur(${(1 - imageOpacity) * 5}px) grayscale(${(1 - imageOpacity) * 100}%)`;
            imgWrapper.style.transform = `scale(${0.9 + (imageOpacity * 0.1)})`;
        }
        if (title) title.style.opacity = Math.min(1, progress * 20).toString();
        if (btnElement) btnElement.style.opacity = (progress > 0.1 ? 1 : 0).toString();
    });

    // 3. ACTUALIZAR CINTAS DE NÚMEROS
    if (activeYearIndex !== -1 && digitStrips.length > 0) {
        digitStrips.forEach((strip, colIndex) => {
            // Verificamos que exista el mapping para evitar errores
            if(clientMappings[colIndex] && clientMappings[colIndex][activeYearIndex] !== undefined) {
                const targetStripIndex = clientMappings[colIndex][activeYearIndex];
                strip.style.transform = `translateY(-${targetStripIndex * YEAR_HEIGHT}px)`;
            }
        });
    }
  });
</script>