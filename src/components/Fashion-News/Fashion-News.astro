---
// src/components/Fashion-News/Fashion-News.astro
import { sanityClient } from "sanity:client";
import { processFashionData } from "../../utils/fashion-math.js";
import StandardView from "./StandardView.astro";
import ImmersiveView from "./ImmersiveView.astro";
import imageUrlBuilder from '@sanity/image-url';

const builder = imageUrlBuilder(sanityClient);
function urlFor(source) {
  return builder.image(source);
}

// 1. Obtener Datos
const data = await sanityClient.fetch(`
  *[_type == "articulo"] | order(year desc) {
    year, title, description, image
  }
`);
const NEWS_ITEMS = data || [];

// 2. Procesar Datos
const { uniqueYears, digitColumns, clientMappings, postsByYear, sortedYears } = processFashionData(NEWS_ITEMS);
---

<div 
  id="fashion-news-container" 
  class="relative bg-theme font-body min-h-screen"
  data-unique-years={JSON.stringify(uniqueYears)}
  data-client-mappings={JSON.stringify(clientMappings)}
>

  {/* BOTÓN TOGGLE */}
  <button id="mode-toggle-btn" class="fixed bottom-6 left-3 md:left-6 z-[70] bg-[#1c1c2e]/90 backdrop-blur-sm text-white shadow-xl rounded-full flex items-center overflow-hidden transition-all duration-500 ease-in-out h-14 w-14 border border-primary">
    <div class="w-14 h-14 flex items-center justify-center flex-shrink-0 relative">
      <svg id="icon-to-standard" class="w-6 h-6 absolute transition-all opacity-100 rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
      <svg id="icon-to-immersive" class="w-6 h-6 absolute transition-all opacity-0 -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
    </div>
    <span id="mode-text" class="whitespace-nowrap font-bold uppercase text-xs tracking-widest pr-6 pl-2 opacity-0 transition-opacity duration-300">Modo Estándar</span>
  </button>

  {/* VISTAS */}
  <StandardView sortedYears={sortedYears} postsByYear={postsByYear} />
  <ImmersiveView newsItems={NEWS_ITEMS} digitColumns={digitColumns} />

  {/* --- SOMBRA E INDICADOR DE SCROLL --- */}
  {/* Usamos 'fixed' para que se pegue a la pantalla, pero lo controlamos por JS para ocultarlo si salimos de la sección */}
  <div 
      id="scroll-hint" 
      class="fixed bottom-0 left-0 w-full h-80 z-[40] pointer-events-none transition-opacity duration-700 opacity-0"
  >
      {/* Gradiente suave que no corta bruscamente */}
      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
      
      <div class="absolute bottom-8 w-full text-center flex flex-col items-center gap-2 animate-bounce">
          <span class="uppercase tracking-[0.2em] text-[10px] md:text-xs font-bold text-white drop-shadow-lg">
              Deslice hacia abajo
          </span>
          <svg class="w-6 h-6 text-white opacity-90 drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
          </svg>
      </div>
  </div>

</div>

<script>
  import { initFashionPage } from "../../scripts/Fashion-News/controller.js";

  const startLogic = () => {
    const container = document.getElementById('fashion-news-container');
    
    if (container) {
      try {
        const uniqueYears = JSON.parse(container.dataset.uniqueYears);
        const clientMappings = JSON.parse(container.dataset.clientMappings);
        console.log("✅ Datos cargados:", uniqueYears);
        initFashionPage({ uniqueYears, clientMappings });
      } catch (e) {
        console.error("❌ Error leyendo datos del DOM:", e);
      }
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startLogic);
  } else {
    startLogic();
  }
  document.addEventListener('astro:page-load', startLogic);
</script>