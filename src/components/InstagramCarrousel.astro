---
// InstagramCarousel.astro

// 1. Definición de Tipos
interface InstagramPost {
  image: string;
  description: string;
}

interface Props {
  posts?: InstagramPost[];
}

// ---------------------------------------------------------
// DATOS LOCALES (MOCK DATA)
// Úsalos mientras conectas la API. Las rutas deben ser relativas a la carpeta 'public'
// ---------------------------------------------------------
const LOCAL_POSTS: InstagramPost[] = [
  {
    image: "/images/Fashion-one.jpg", // Asegúrate de tener esta imagen en public/images/
    description: "Nuestros nuevos diseños de temporada combinan texturas suaves con durabilidad industrial. #Textil #Diseño"
  },
  {
    image: "/images/Fashion-two.jpg",
    description: "La calidad se siente en cada hilo. Proceso de verificación de tejidos en nuestra planta principal."
  },
  {
    image: "/images/Fashion-three.jpg",
    description: "Colores que inspiran. Nuestra nueva paleta cromática está lista para tus proyectos."
  },
  {
    image: "/images/Fashion-four.jpg",
    description: "Innovación y tradición se unen en nuestra nueva colección de otoño."
  }
];

// 2. Lógica de Selección de Datos
const { posts: propPosts } = Astro.props;

// Si vienen posts por props (API), úsalos. Si no, usa los LOCAL_POSTS.
const posts = (propPosts && propPosts.length > 0) ? propPosts : LOCAL_POSTS;

// Función auxiliar de truncado
function truncateText(text: string, maxLength: number): string {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  let subString = text.substring(0, maxLength);
  return subString.substring(0, subString.lastIndexOf(" ")) + "...";
}
---

<div class="w-full overflow-hidden relative py-10 bg-theme">
  
  <div 
    id="instaTrack" 
    class="flex gap-6 w-max will-change-transform cursor-grab active:cursor-grabbing"
  >
    {posts.map((post) => (
      <article class="
        flex-shrink-0 flex flex-col 
        bg-second-theme rounded-2xl shadow-md overflow-hidden 
        transition-all duration-300 hover:-translate-y-1 hover:shadow-xl
        w-[85vw] max-w-[400px] md:w-[320px] lg:w-[360px]
      ">
        
        <div class="relative w-full aspect-square overflow-hidden group">
          <img 
            src={post.image} 
            alt="Instagram Post" 
            loading="lazy" 
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
          />
          
          
        </div>

        <div class="flex-grow p-5 flex flex-col bg-surface">
          <p class="text-muted text-sm leading-relaxed font-normal break-words">
            {truncateText(post.description, 120)} 
          </p>
        </div>
      </article>
    ))}
  </div>
</div>

<script>
  // Script Vanilla JS para el movimiento infinito
  document.addEventListener('DOMContentLoaded', () => {
    // Usamos 'as HTMLElement' para satisfacer a TypeScript
    const track = document.getElementById('instaTrack') as HTMLElement;
    
    if (!track) return;

    const items = Array.from(track.children);
    if (items.length === 0) return;

    items.forEach(item => {
      const clone = item.cloneNode(true) as Element; 
      clone.setAttribute('aria-hidden', 'true');
      track.appendChild(clone);
    });

    let position = 0;
    const speed = 0.3;
    let isPaused = false;
    let animationId;

    const stop = () => isPaused = true;
    const play = () => isPaused = false;

    track.addEventListener('mouseenter', stop);
    track.addEventListener('mouseleave', play);
    track.addEventListener('touchstart', stop, { passive: true });
    track.addEventListener('touchend', play);

    function animate() {
      if (!isPaused) {
        position -= speed;
        
        // Usamos el operador ! (Non-null assertion) o confiamos en la variable track ya validada
        const halfWidth = track.scrollWidth / 2;
        
        if (Math.abs(position) >= halfWidth) {
          position = 20;
        }
        
        track.style.transform = `translateX(${position}px)`;
      }
      animationId = requestAnimationFrame(animate);
    }

    animationId = requestAnimationFrame(animate);
  });
</script>